<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <script type="text/javascript" src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
    <script type="text/javascript" src="https://unpkg.com/web3@0.20.5/dist/web3.js"></script>
   <!-- This exposes the library as a global variable: ethers -->
<script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"charset="utf-8"type="text/javascript"></script>
   
    <!-- The generated javascript and app.js will be substituted in below -->
    <!-- JAVASCRIPT -->
	<script>
	/* Autogenerated - do not fiddle */
            if(typeof(Contracts) === "undefined") var Contracts={};
            (function(module, Contracts) {
                var data = {
                    address: "0x264c72101dfa0ed863cbbdfe91f2c94e0e72d862",
                    network: "Ropsten",
                    endpoint: "",
                    abi: [
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "address"
            }
        ],
        "name": "createAdmin",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_tasksCompleted",
                "type": "uint256"
            },
            {
                "name": "key",
                "type": "address"
            }
        ],
        "name": "updateUserComplete",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "name": "userStructs",
        "outputs": [
            {
                "name": "userName",
                "type": "string"
            },
            {
                "name": "userTier",
                "type": "uint8"
            },
            {
                "name": "userType",
                "type": "uint8"
            },
            {
                "name": "tasksCompleted",
                "type": "uint256"
            },
            {
                "name": "accountStatus",
                "type": "uint8"
            },
            {
                "name": "isAdmin",
                "type": "bool"
            },
            {
                "name": "accountBalance",
                "type": "uint256"
            },
            {
                "name": "accountEscrow",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_passFail",
                "type": "bool"
            },
            {
                "name": "key",
                "type": "bytes32"
            },
            {
                "name": "_add",
                "type": "address"
            }
        ],
        "name": "reviewWork",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "transferEscrow",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "userLists",
        "outputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "RootAdmin",
        "outputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "address"
            }
        ],
        "name": "restrictAccount",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "userAccounts",
        "outputs": [
            {
                "name": "userName",
                "type": "string"
            },
            {
                "name": "userTier",
                "type": "uint8"
            },
            {
                "name": "userType",
                "type": "uint8"
            },
            {
                "name": "tasksCompleted",
                "type": "uint256"
            },
            {
                "name": "accountStatus",
                "type": "uint8"
            },
            {
                "name": "isAdmin",
                "type": "bool"
            },
            {
                "name": "accountBalance",
                "type": "uint256"
            },
            {
                "name": "accountEscrow",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "key",
                "type": "address"
            }
        ],
        "name": "getUser",
        "outputs": [
            {
                "name": "_userName",
                "type": "string"
            },
            {
                "name": "_userTier",
                "type": "uint8"
            },
            {
                "name": "_userType",
                "type": "uint8"
            },
            {
                "name": "_tasksCompleted",
                "type": "uint256"
            },
            {
                "name": "_accountStatus",
                "type": "uint8"
            },
            {
                "name": "_isAdmin",
                "type": "bool"
            },
            {
                "name": "_accountBalance",
                "type": "uint256"
            },
            {
                "name": "_accountEscrow",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "userName",
                "type": "string"
            },
            {
                "name": "_index",
                "type": "uint256"
            }
        ],
        "name": "newUser",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "cashOut",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            },
            {
                "name": "_contractName",
                "type": "string"
            },
            {
                "name": "_taskTier",
                "type": "uint256"
            },
            {
                "name": "_quota",
                "type": "uint256"
            },
            {
                "name": "amount",
                "type": "uint256"
            }
        ],
        "name": "createContract",
        "outputs": [
            {
                "name": "_idNumber",
                "type": "bytes32"
            }
        ],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "updateUserTier",
        "outputs": [
            {
                "name": "_success",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "getContractCount",
        "outputs": [
            {
                "name": "count",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            },
            {
                "name": "_contractName",
                "type": "string"
            }
        ],
        "name": "updateContract",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "getContractAtIndex",
        "outputs": [
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "address"
            }
        ],
        "name": "workerPass",
        "outputs": [
            {
                "name": "",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "removeContract",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_passFail",
                "type": "bool"
            },
            {
                "name": "_workerAdd",
                "type": "address"
            },
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "arbitrateWork",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "getUserCount",
        "outputs": [
            {
                "name": "count",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "completeWork",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "address"
            }
        ],
        "name": "demoteAdmin",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "closeContract",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "getContract",
        "outputs": [
            {
                "name": "_ContractOwner",
                "type": "address"
            },
            {
                "name": "_contractName",
                "type": "string"
            },
            {
                "name": "_value",
                "type": "uint256"
            },
            {
                "name": "_quota",
                "type": "uint256"
            },
            {
                "name": "_payout",
                "type": "uint256"
            },
            {
                "name": "_userTier",
                "type": "uint8"
            },
            {
                "name": "_balance",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "appointArbitrator",
        "outputs": [
            {
                "name": "success",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "address"
            },
            {
                "name": "_userName",
                "type": "string"
            },
            {
                "name": "_userType",
                "type": "uint8"
            }
        ],
        "name": "updateUser",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "getUserIndex",
        "outputs": [
            {
                "name": "key",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "key",
                "type": "address"
            }
        ],
        "name": "restoreAccount",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "_username",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "_userType",
                "type": "uint8"
            }
        ],
        "name": "NewUserRegistered",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "_success",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "_userTier",
                "type": "uint8"
            }
        ],
        "name": "UserTierUpgrade",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            }
        ],
        "name": "appointedArbitrator",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            }
        ],
        "name": "newAdmin",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            }
        ],
        "name": "removeAdmin",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            }
        ],
        "name": "newRestrictedAccount",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            }
        ],
        "name": "removeRestrictAccount",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "_value",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "_payout",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "_usertier",
                "type": "uint8"
            }
        ],
        "name": "ContractCreated",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "_bal",
                "type": "uint256"
            },
            {
                "indexed": true,
                "name": "_contract",
                "type": "bytes32"
            }
        ],
        "name": "ContractClosed",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "payout",
                "type": "uint256"
            }
        ],
        "name": "workDone",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "bytes32"
            },
            {
                "indexed": false,
                "name": "_payout",
                "type": "uint256"
            }
        ],
        "name": "workDone",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "_bal",
                "type": "uint256"
            }
        ],
        "name": "userCashOut",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_contract",
                "type": "bytes32"
            },
            {
                "indexed": false,
                "name": "_arbitrateResult",
                "type": "bool"
            }
        ],
        "name": "arbitrationWorking",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": false,
                "name": "_balance",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "key",
                "type": "bytes32"
            }
        ],
        "name": "transferEscrowOut",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "name": "_from",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_to",
                "type": "address"
            },
            {
                "indexed": true,
                "name": "_fromKey",
                "type": "bytes32"
            },
            {
                "indexed": false,
                "name": "_passFail",
                "type": "bool"
            }
        ],
        "name": "callArbitration",
        "type": "event"
    }
]
                };
                Contracts["TaskChain"] = data;
                console.log(data);
                module.exports = data;
            })((typeof(module) === "undefined" ? {} : module), Contracts);
			
// The object 'Contracts' will be injected here, which contains all data for all contracts, keyed on contract name:
// Contracts['HelloWorld'] = {
//  abi: [],
//  address: "0x..",
//  endpoint: "http://...."
// }

// Create an instance of the smart contract, passing it as a property, 
// which allows web3js to interact with it.
function TaskChain(Contract) {
    this.web3 = null;
    this.instance = null;
    this.Contract = Contract;
    console.log("LOAD Success");
}

// Initialize the `Coin` object and create an instance of the web3js library, 
TaskChain.prototype.init = function () {
    // The initialization function defines the interface for the contract using 
    // the web3js contract object and then defines the address of the instance 
    // of the contract for the `Coin` object.

    // Create a new Web3 instance using either the Metamask provider
    // or an independent provider created as the endpoint configured for the contract.
    this.web3 = new Web3(
        (window.web3 && window.web3.currentProvider) ||
        new Web3.providers.HttpProvider(this.Contract.endpoint));

    // Create the contract interface using the ABI provided in the configuration.
    var contract_interface = this.web3.eth.contract(this.Contract.abi);

    // Create the contract instance for the specific address provided in the configuration.
    this.instance = contract_interface.at(this.Contract.address);
};



//create new User
TaskChain.prototype.createNewUser = function () {
    var that = this;

    // Get input values for userName and userType
    var userName = $("#userName").val();
    var userType = $("#userType").val();
    console.log("Username:", userName);
    console.log("Usertype:", userType);



    //calls new User function, adds to blockchain
    this.instance.newUser(userName, userType, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        // If there's an error, log it
        function (error, txHash) {
            if (error) {
                console.log("error1", error);
            }
            // If success then wait for confirmation of transaction
            // with utility function and clear form values while waiting
            else {
                that.waitForReceipt(txHash, function (receipt) {
                    if (receipt.status) {
                        $("#userName").val("");
                        showStatus("User " + userName + " created!")
                    }
                    else {
                        console.log("error in user");
                        showStatus("error in user create")
                    }
                });
            }
        }
    )
}

//upgrades user to new user tier
TaskChain.prototype.upgradeUser = function (hash, cb) {
    var that = this;
    console.log("this check")

    
    //upgrades user tier
   this.instance.updateUserTier({ from: window.web3.eth.accounts[0], gasLimit: 5000000 },
        function (error, _success) {
            if (error) {
                console.log(error);
            }
            else {
                console.log("SUCCESS!", _success);
                showStatus("Transaction Complete!")
            }
        })
}

//creates a new arbitrator class to user calling function
TaskChain.prototype.createArb = function (hash, cb) {
    var that = this;
    console.log("this check")

    //records address of account calling
    var address = window.web3.eth.accounts[0];

    this.instance.appointArbitrator({ from: window.web3.eth.accounts[0], gasLimit: 1000000 },
        function (error, txHash) {
            if (error) {
                console.log(error);
                showStatus(error);
            }
            else {
                that.waitForReceipt(txHash, function (receipt) {
                    if (receipt !== null) {
                        console.log("success");
                        showStatus("Transaction Completed")
                    }
                    else {
                        console.log("receipt error");
                        showStatus("Transaction Failure")

                    }
                });
            }
        }
    )
}



// Waits for receipt of transaction
TaskChain.prototype.waitForReceipt = function (hash, cb) {
    var that = this;

    // Checks for transaction receipt using web3 library method
    this.web3.eth.getTransactionReceipt(hash, function (err, receipt) {
        if (err) {
            console.log("Transaciton Receipt Error");
            error(err);
        }
        if (receipt !== null) {
            // Transaction went through
            if (cb) {
                console.log("receipt1");
                cb(receipt);
                console.log("receipt2");

            }
        } else {
            // Try again in 2 second
            console.log("receipt2");
            window.setTimeout(function () {
                that.waitForReceipt(hash, cb);
            }, 2000);
        }
    });
}


//calls user structure
TaskChain.prototype.isUser = function (hash, cb) {
    var that = this;

    // Get input values
    var userAddress = $("#userCheckAddress").val();
    if (!isValidAddress(userAddress)) {
        showStatus("Please enter a valid address");
        return;
    }

    console.log(userAddress);

    this.instance.getUser(userAddress,
        function (error, userStruct) {
            if (error) {
                console.log(error);
            }
            else {
                console.log(userStruct);
                $("#message").text(userStruct);
            }
        })
}

//calls user structure
TaskChain.prototype.getUserIndex = function (hash, cb) {
    var that = this;

    // Get input values
    var userIndex = $("#userIndex").val();
    

    console.log(userIndex);

    this.instance.getUserIndex(userIndex,
        function (error, userAddress) {
            if (error) {
                console.log(error);
            }
            else {
                console.log(userAddress);
                $("#userAddressRetrieve").text(userAddress);
            }
        })
}

//calls user structure
TaskChain.prototype.getUserCount = function (hash, cb) {
    var that = this;
    console.log("part1: Pre Count")



    this.instance.getUserCount(
        function (error, userCount) {
            if (error) {
                console.log(error);
            }
            else {
                console.log(userCount);
                $("#userNumberRetrieve").text(userCount);
            }
        })
}


// creates new admin user, only called by rootadmin
TaskChain.prototype.appAdmin = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#adminAddress").val();
    console.log(address);
    if (!isValidAddress(address)) {
        showStatus("Please enter a valid address");
        return;
    }


    //appoints admin
    this.instance.createAdmin(address, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        showStatus("Transaction Complete");
                    }
                    else {
                        console.log("receipt error");

                    }
                });
            }
        }
    )
}

//demotes admin
TaskChain.prototype.demAdmin = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#adminAddress").val();
    if (!isValidAddress(address)) {
        showStatus("Please enter a valid address");
        return;
    }
    console.log(address);


    // gets address, msg.sender, and demotes
    this.instance.createAdmin(address, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        showStatus("Transaction Complete");
                    }
                    else {
                        console.log("receipt error");

                    }
                });
            }
        }
    )
}

//restricts accounts, called by admins
TaskChain.prototype.restrictAccount = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#restrictAccountAddress").val();
    console.log(address);
    if (!isValidAddress(address)) {
        showStatus("Please enter a valid address");
        return;
    }

    this.instance.restrictAccount(address, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        showStatus("Transaction Complete");
                    }
                    else {
                        console.log("receipt error");

                    }
                });
            }
        }
    )
}

//restores resctricted account
TaskChain.prototype.restoreAccount = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#restrictAccountAddress").val();
    if (!isValidAddress(address)) {
        showStatus("Please enter a valid address");
        return;
    }
    console.log(address);


    // Check the balance from the address 
    this.instance.restoreAccount(address, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        showStatus("Transaction Complete");
                    }
                    else {
                        console.log("receipt error");

                    }
                });
            }
        }
    )
}

TaskChain.prototype.createContract = function () {
    var that = this;
    console.log("this check")



    // Get input values, the address  
    var address = window.web3.eth.accounts[0];
    var contractTitle = $("#contractName").val();
    var value = $("#msgValue").val();
    var quota = $("#quota").val();
    var tasktier = $("#taskTier").val();
    var newConcat = address.concat(contractTitle);   
    console.log("Contract Title", contractTitle);
    console.log("value: ", value);
    console.log("quota: ", quota);
    console.log("tasktier: ", tasktier);
    console.log("Concat", newConcat);       
    let newHex = ethers.utils.formatBytes32String(contractTitle);
    let randomHex = ethers.utils.bigNumberify(ethers.utils.randomBytes(32));
    randomNumber = randomHex.toHexString();
  
    console.log("Bytes", newHex);
    console.log("random", randomHex);
    console.log("random2", randomNumber);

    // Check the balance from the address 
    this.instance.createContract(newHex, contractTitle, tasktier, quota, value, { from: window.web3.eth.accounts[0], value: value, gasLimit: 750000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            console.log(error);
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        $("#completeWorkAddress").val("");
                        showStatus("Transaction Complete!");

                    }
                    else {
                        console.log("receipt error");
                        showStatus("Transaction Error!");

                    }
                });
            }
        }
    )
}


//calls contract structure
TaskChain.prototype.getContract = function (hash, cb) {
    var that = this;

    // Get input values
    var key = $("#contractKey").val();
    
    console.log("contract key: ", key);

    this.instance.getContract(key,
        function (error, contractStruct) {
            if (error) {
                console.log(error);
            }
            else {
                console.log(contractStruct);
                $("#ContractInfoRetrieve").text(contractStruct);
                $("#contractKey").val("");
            }
        })
}


//calls contract structure
TaskChain.prototype.getContractAtIndex = function (hash, cb) {
    var that = this;

    // Get input values
    var contractIndex = $("#contractIndex").val();
    
    console.log("contract key: ", contractIndex);

    this.instance.getContractAtIndex(contractIndex,
        function (error, contractStruct) {
            if (error) {
                console.log(error);
            }
            else {
                console.log(contractStruct);
                $("#ContractKeyRetrieve").text(contractStruct);
                $("#contractIndex").val("");
            }
        })
}


TaskChain.prototype.completeWork = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#completeWorkAddress").val();
    var newAddress = { from: window.web3.eth.accounts[0]};
    console.log("sender addrewss", newAddress);
   
    console.log(address);

    // Check the balance from the address 
    this.instance.completeWork(address, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        $("#completeWorkAddress").val("");
                        showStatus("Transaction Complete!");
                    }
                    else {
                        console.log("receipt error");
                        showStatus("Transaction Error!");

                    }
                });
            }
        }
    )
}

TaskChain.prototype.reviewWork = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#reviewAddress").val();
    var key =  $("#contractKeyReview").val();
    var passFailVal = $("#reviewPassFail").val();
    console.log("boolValue", passFailVal);

    
    console.log("address", address);
    console.log("key", key);
    console.log("passFail", passFailVal);
    

    if (!isValidAddress(address)) {
        showStatus("Please enter a valid address");
        return;
    }
    console.log(address);

    // Check the balance from the address 
    this.instance.reviewWork(passFailVal, key, address,{ from: window.web3.eth.accounts[0], gasLimit: 500000000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        $("#reviewAddress").val("");
                        showStatus("Complete!");
                    }
                    else {
                        console.log("receipt error");
                        console.log(receipt);
                        showStatus("error");

                    }
                });
            }
        }
    )
}


TaskChain.prototype.arbitrateWork = function () {
    var that = this;
    console.log("this check")

    // Get input values, the address
    var address = $("#contractArbAdd").val();
    var workerAddress = $("#workerArbAdd").val();
    var passFail = $("#arbitrateWork").val();

   
    if (!isValidAddress(workerAddress)) {
        showStatus("Please enter a valid address");
        return;
    }
    console.log(address);

    // Check the balance from the address 
    this.instance.arbitrateWork(passFail, workerAddress, address, { from: window.web3.eth.accounts[0], gasLimit: 500000 },
        console.log("error1"),
        function (error, txHash) {
            console.log("erorrrr")
            if (error) {
                console.log("error2");
                console.log(error);
            }
            else {
                console.log("elsechain");
                that.waitForReceipt(txHash, function (receipt) {
                    console.log("error3");
                    if (receipt.status == 1) {
                        console.log("success");
                        $("#contractArbAdd").val("");
                        $("#workerArbAdd").val("");
                    }
                    else {
                        console.log("receipt error");

                    }
                });
            }
        }
    )
}

//upgrades user to new user tier
TaskChain.prototype.transferEscrow = function (hash, cb) {
    var that = this;
    console.log("this check")

    //address of caller
    var key = $("#escrowCashKey").val();    

    //upgrades user tier
    this.instance.transferEscrow(key, { from: window.web3.eth.accounts[0], gasLimit: 5000000 },
        function (error, txHash) {
            if (error) {
                console.log(error);
            }
            else {
                that.waitForReceipt(txHash, function (receipt) {
                    if (receipt !== null) {
                        console.log("success");
                        showStatus("Transaction Completed!")
                    }
                    else {
                        console.log("receipt error");
                        showStatus("Error in Transaciton")

                    }
                });
            }
        }
    )
}

//upgrades user to new user tier
TaskChain.prototype.workCashOut = function (hash, cb) {
    var that = this;
    console.log("this check")

    //address of caller
    var address = window.web3.eth.accounts[0];

    //upgrades user tier
    this.instance.cashOut({ from: window.web3.eth.accounts[0], gasLimit: 5000000 },
        function (error, txHash) {
            if (error) {
                console.log(error);
            }
            else {
                that.waitForReceipt(txHash, function (receipt) {
                    if (receipt !== null) {
                        console.log("success");
                        showStatus("Transaction Completed!")
                    }
                    else {
                        console.log("receipt error");
                        showStatus("Error in Transaciton")

                    }
                });
            }
        }
    )
}



//upgrades user to new user tier
TaskChain.prototype.checkContractBal = function (hash, cb) {
    var that = this;
    console.log("this check")

    //address of caller
    var address = window.web3.eth.accounts[0];

    //upgrades user tier
    this.instance.checkContractBal({ from: window.web3.eth.accounts[0], gasLimit: 5000000 },
        function (error, balance) {
            if (error) {
                console.log(error);
            }
            else {
                console.log(balance.toNumber());
                $("#contractBalanceMessage").text(balance.toNumber());
            }
        })
}

//upgrades user to new user tier
TaskChain.prototype.closeContractTag = function (hash, cb) {
    var that = this;
    console.log("this check")

    //address of caller
    var address = window.web3.eth.accounts[0];
    var key = $("#closeContractKey").val();  

    //upgrades user tier
    this.instance.closeContract(key, { from: window.web3.eth.accounts[0], gasLimit: 5000000 },
        function (error, txHash) {
            if (error) {
                console.log(error);
            }
            else {
                that.waitForReceipt(txHash, function (receipt) {
                    if (receipt !== null) {
                        console.log("success");
                        showStatus("Transaction Completed!")
                    }
                    else {
                        console.log("receipt error");
                        showStatus("Error in Transaciton")

                    }
                });
            }
        }
    )
}

// Check if it has the basic requirements of an address
function isValidAddress(address) {
    return /^(0x)?[0-9a-f]{40}$/i.test(address);
}

// Basic validation of amount. Bigger than 0 and typeof number
function isValidAmount(amount) {
    return amount > 0 && typeof Number(amount) == 'number';
}

// Bind functions to the buttons defined in app.html
TaskChain.prototype.bindButtons = function () {
    var that = this;

    $(document).on("click", "#createUser", function () {
        console.log('usertryClick')
        that.createNewUser();
        console.log('UserClick')
    });

    $(document).on("click", "#getUserCountBtn", function () {
        console.log('usertryClick')
        that.isUser();
        console.log('UserClick')
    });

    $(document).on("click", "#getUserAtIndexBtn", function () {
        console.log('usertryClick')
        that.getUserIndex();
        console.log('UserClick')
    });

     $(document).on("click", "#getUserNumberBtn", function () {
        console.log('usertryClick')
        that.getUserCount();
        console.log('UserClick')
    });

    

    

    $(document).on("click", "#updateUserTier", function () {
        console.log('usertryClick')
        that.upgradeUser();
        console.log('UserClick')
    });

    $(document).on("click", "#appointArbitrator", function () {
        console.log('usertryClick')
        that.createArb();
        console.log('UserClick')
    });

    $(document).on("click", "#createAdmin", function () {
        console.log('usertryClickAdmin')
        that.appAdmin();
        console.log('UserClick')
    });

    $(document).on("click", "#demoteAdmin", function () {
        console.log('usertryClickAdmin')
        that.demAdmin();
        console.log('UserClick')
    });

    $(document).on("click", "#restrictAccount", function () {
        console.log('usertryClickAdmin')
        that.restrictAccount();
        console.log('UserClick')
    });

    $(document).on("click", "#restoreAccount", function () {
        console.log('usertryClickAdmin')
        that.restoreAccount();
        console.log('UserClick')
    });

    $(document).on("click", "#createContract", function () {
        console.log('usertryClickAdmin')
        that.createContract();
        console.log('UserClick')
    });

    
    $(document).on("click", "#getContractAtIndex", function () {
        console.log('usertryClickAdmin')
        that.getContractAtIndex();
        console.log('UserClick')
    });


    

    $(document).on("click", "#completeWork", function () {
        console.log('usertryClickAdmin')
        that.completeWork();
        console.log('UserClick')
    });

    $(document).on("click", "#getContractAtKey", function () {
        console.log('usertryClickAdmin')
        that.getContract();
        console.log('UserClick')
    });

    $(document).on("click", "#transferEscrow", function () {
        console.log('usertryClickAdmin')
        that.transferEscrow();
        console.log('UserClick')
    });

      $(document).on("click", "#reviewWork", function () {
        console.log('usertryClickAdmin')
        that.reviewWork();
        console.log('UserClick')
    });    

    $(document).on("click", "#workCashOut", function () {
        console.log('usertryClickAdmin')
        that.workCashOut();
        console.log('UserClick')
    });

    $(document).on("click", "#arbitratorCashOut", function () {
        console.log('usertryClickAdmin')
        that.arbitratorCashOut();
        console.log('UserClick')
    });

    $(document).on("click", "#closeContractButton", function () {
        console.log('close contract')
        that.closeContractTag();
        console.log('UserClick Close Contract')
    });

    $(document).on("click", "#checkContractBal", function () {
        console.log('usertryClickAdmin')
        that.checkContractBal();
        console.log('UserClick')
    });

}

function showStatus(text) {
    alert(text);
}

// Create the instance of the `TaskChain` object 
TaskChain.prototype.onReady = function () {
    this.bindButtons();
    this.init();
};

if (typeof (Contracts) === "undefined") var Contracts = { TaskChain: { abi: [] } };
var task = new TaskChain(Contracts['TaskChain']);

$(document).ready(function () {
    task.onReady();
});
	
	</script>

    <!-- The app.css contents will be substituted in below -->
    <!-- STYLE -->

    <style>
        body,
        h1,
        h2,
        h3,
        h4,
        h5 {
            font-family: "Raleway", sans-serif
        }
    </style>

<body class="w3-light-grey">
    <nav class="w3-sidebar w3-indigo w3-collapse w3-top w3-large w3-padding"
        style="z-index:3;width:300px;font-weight:bold;" id="mySidebar"><br>
        <a href="javascript:void(0)" onclick="w3_close()" class="w3-button w3-hide-large w3-display-topleft"
            style="width:100%;font-size:22px">Close Menu</a>
        <div class="w3-container">
            <h3 class="w3-padding-64"><b>TaskChain<br>Functions</b></h3>
        </div>

        <!-- Top menu on small screens -->
        <header class="w3-container w3-top w3-hide-large w3-red w3-xlarge w3-padding">
            <a href="javascript:void(0)" class="w3-button w3-red w3-margin-right" onclick="w3_open()"></a>
            <span>TaskChain Functions Menu</span>
        </header>
        <div class="w3-bar-block">
            <a href="#" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Home</a>
            <a href="#newUserInputTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">New User</a>
            <a href="#upgradeTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Upgrade User</a>
            <a href="#arbitratorTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Create
                Arbitrator</a>
            <a href="#createAdminTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Appoint
                Admin</a>
            <a href="#adminControlTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Admin Access
                Control</a>
            <a href="#createContractTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Create
                Contract</a>
            <a href="#performWorkTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Perform Work</a>
            <a href="#reviewWorkTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Review Work</a>
            <a href="#arbitrateWorkTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Arbitrate
                Work</a>
            <a href="#transferEscrowTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Transfer
                Escrow</a>
            <a href="#cashOutWorkerTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Cash Out
                (Worker)</a>
            <a href="#cashOutArbitratorTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Cash Out
                (Arbitrator)</a>
            <a href="#checkContractBalTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Check
                Contract Balance</a>
            <a href="#closeContractTag" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Close
                Contract</a>

        </div>
    </nav>
    <div class="w3-main" style="margin-left:340px;margin-right:40px">

        <h1>Welcome to TaskChain </h1><br>
        <div class="message"></div>
        <h2><b>New User and Adminstrative Section</b></h2>
        <hr style="width:50px;border:5px solid red" class="w3-round">

        <div class="w3-content">
            <div></div>
            <h3 id="newUserInputTag">Please Input User Name and Type</h3>
            <label for="userName">userName</label><br>
            <input type="text" id="userName" placeholder="User Name"><br>
            <form>
                <select id="userType">
                    <option value="0">Creator</option>
                    <option value="1">Worker</option>
                </select>
            </form>
            <button class="w3-ripple w3-white w3-hover-indigo" id="createUser">Create User</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="getUserCountTag">Get User at Address</h3>
            <label for="userCheckAddress">Address:</label>
            <input type="text" id="userCheckAddress" placeholder="address"><br>
            <button class="btn" id="getUserCountBtn">Get User</button>
            <h4 class="text message">User Struct:&nbsp;<span id="message"></span></h4>
            <h4 class="text message">Key: Username, User Tier, userType, tasksCompleted, account status, admin status, account balance, account escrow</h4>
        </div><br><br>

        <div class="w3-content">
            <h3 id="getUserAtIndexTag">User Index</h3>  
            <label for="userIndex">Get User at Index</label><br>
            <input type="number" id="userIndex" placeholder="Index"><br>
           <button class="btn" id="getUserAtIndexBtn">Get User(Index)</button>            
             <h4 class="text message">User Address:&nbsp;<span id="userAddressRetrieve"></span></h4>
        </div><br><br>


        <div class="w3-content">
            <h3 id="getUserNumberTag">Get Number of Users</h3>
            <button class="btn" id="getUserNumberBtn">Get Number</button>
             <h4 class="text message">Number of Users:&nbsp;<span id="userNumberRetrieve"></span></h4>
        </div><br><br>

        <div class="w3-content">
            <h3 id="upgradeTag">Upgrade User to New Tier</h3>
            <button class="btn" id="updateUserTier">Upgrade User</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="arbitratorTag">Create Arbitrator</h3>
            <button class="btn" id="appointArbitrator">Request Arbitrator Status</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="createAdminTag">Appoint Admin</h3>
            <label for="adminAddress">Admin Address:</label>
            <input type="text" id="adminAddress" placeholder="address"><br>
            <button class="btn" id="createAdmin">Upgrade to Admin</button>
            <button class="btn" id="demoteAdmin">Demote Admin</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="adminControlTag">Admin Access Control</h3>
            <label for="restrictAccountAddress">Address to be Changed:</label>
            <input type="text" id="restrictAccountAddress" placeholder="address"><br>
            <button class="btn" id="restrictAccount">Restrict Account</button>
            <button class="btn" id="restoreAccount">Restore Account</button>
        </div><br><br>
        <h2><b>TaskCreate Section</b></h2>
        <hr style="width:50px;border:5px solid red" class="w3-round">

        <div class="w3-content">
            <h3 id="createContractTag">Create New Contract</h3>
            <label for="contractName">Contract Title:</label><br>
            <input type="text" id="contractName" placeholder="Contract Title"><br>
            <label for="msgValue">Task Total Value:</label><br>
            <input type="number" id="msgValue" placeholder="Value"><br>
            <label for="quota">Number of Workers Desired:</label><br>
            <input type="number" id="quota" placeholder="Quota">
            <form>
                <select id="taskTier">
                    <option value="0">Tier One</option>
                    <option value="1">Tier Two</option>
                    <option value="2">Tier Three</option>
                </select>
            </form>

            <button class="btn" id="createContract">Create Contract</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="getContractTag">Review Contract</h3>
            <label for="contractKey">Input Contract Key</label><br>
            <input type="text" id="contractKey" placeholder="Key"></br>
            <button class="btn" id="getContractAtKey">Get Contract(Key)</button><br>
            <h4 class="text message">Contract:&nbsp;<span id="ContractInfoRetrieve"></span></h4>
           </div><br><br>
        <div class="w3-content">
            <h3 id="getContractAtIndexTag">Contract Index</h3>  
            <label for="contractIndex">Get Contract at Index</label><br>
            <input type="number" id="contractIndex" placeholder="Index"><br>
           <button class="btn" id="getContractAtIndex">Get Contract(Index)</button>            
             <h4 class="text message">Contract Key:&nbsp;<span id="ContractKeyRetrieve"></span></h4>



        </div><br><br>

        <div class="w3-content">            
            <h3 id="performWorkTag">Perform Work</h3>
            <label for="completeWorkAddress">Task Key:</label>
            <input type="text" id="completeWorkAddress" placeholder="Key"><br>
            <button class="btn" id="completeWork">Complete Work</button>            
        </div><br><br>

        <div class="w3-content">
            <h3 id="reviewWorkTag">Review Work(Creator)</h3>
            <label for="reviewAddress">Address to Review: </label>
            <input type="text" id="reviewAddress" placeholder="Address"><br>
            <label for="contractKeyReview">Contract Key: </label>
            <input type="text" id="contractKeyReview" placeholder="Key">
            <form>
                <select id="reviewPassFail">
                    <option value=true>Pass</option>
                    <option value=false>Fail</option>
                </select>
            </form><br>
            <button class="btn" id="reviewWork">Complete Review</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="arbitrateWorkTag">Arbitrate Work</h3>
            <label for="contractArbAdd">Contract Key: </label>
            <input type="text" id="contractArbAdd" placeholder="Key"><br>
            <label for="workerArbAdd">Worker Address: </label>
            <input type="text" id="workerArbAdd" placeholder="Address"><br>
            <form id="reviewArbPassFail">
                <select>
                    <option value=0>Pass</option>
                    <option value=1>Fail</option>
                </select>
            </form><br>
            <button class="btn" id="arbitrateWork">Complete Arbitration</button>
        </div><br><br>
        <div class="w3-content">
            <h3 id="transferEscrowTag">Transfer from Escrow(Workers)</h3>
            <label for="escrowCashKey">Contract Key:</label>            
            <input type="text" id="escrowCashKey" placeholder="Key">
            <button class="btn" id="transferEscrow">Transfer to Account</button>
        </div><br><br>

        <div class="w3-content">
            <h3 id="cashOutWorkerTag">Cash Out</h3>
            <button class="btn" id="workCashOut">Cash out Balance</button>
        </div><br><br>       
        

        <div class="w3-content">
            <h3 id="closeContractTag">Close Contract(Creator)</h3>
             <label for="closeContractKey">Contract Key: </label>
            <input type="text" id="closeContractKey" placeholder="Key"><br>
            <button class="btn" id="closeContractButton">Close Contract</button>
            
        </div><br><br>

   


        </head>

        <body>
            <h1><span id="message"></span></h1>
        </body>

</html>
